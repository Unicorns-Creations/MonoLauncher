<!DOCTYPE html>
<html>


<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="imsg.css">
  <script src="https://kit.fontawesome.com/2c4b435336.js" crossorigin="anonymous"></script>
  <script src="imsg.js" crossorigin="anonymous"></script>
</head>

<header>
  <div id="header-root"></div>
</header>

<body>
  <span id="actionBar"><a onclick="window.location.href='../../monotablet.html'"><i
        class="fas fa-chevron-circle-left"></i></a> 100% <i class="fas fa-battery-full"></i> <i class="fas fa-wifi"></i>
    <span id="timeNow">00:00:00</span></span>
  <script>
    const {
      ipcRenderer
    } = require('electron');

    function currentTime() {
      var date = new Date();
      var hour = date.getHours();
      var min = date.getMinutes();
      var sec = date.getSeconds();
      hour = updateTime(hour);
      min = updateTime(min);
      sec = updateTime(sec);
      document.getElementById("timeNow").innerText = hour + ":" + min + ":" + sec;
      var t = setTimeout(function () {
        currentTime()
      }, 1000);
    }

    function updateTime(k) {
      if (k < 10) {
        return "0" + k;
      } else {
        return k;
      }
    }

    currentTime();
  </script>

  <div id="participants">
    <input id="search">
    <button onclick="createMsg()">New Msg</button>
  </div>

  <div id="messages">
    <div id="messageAuthor">
      <img id="AuthorAvatar" src="../../imgs/squestion.jpg">
      <h2 id="AuthorName">WIP</h2>
    </div>
    <div id="messageContainer">

    </div>

  </div>

  <script>
    function map(fn, map) {
      if (typeof thisArg !== 'undefined')
        fn = fn.bind(thisArg);
      const iter = map.entries();
      return Array.from({
        length: map.size
      }, () => {
        const [key, value] = iter.next().value;
        return fn(value, key, this);
      });
    }

    async function getMessages(id) {
      ipcRenderer.invoke('request-imsgs').then(function (result) {
        if (result == "404") {
          createMsg("Couldn't find Gmod", true)
          return
        }
        var mParent = document.getElementById("messageContainer");
        var authorElement = document.getElementById("AuthorName");

        mParent.innerHTML = ""
        result.forEach(rs => {
          if (rs.id != id) return
          authorElement.innerText = rs.name
          console.log(rs)
          rs.chats.forEach(chat => {
            console.log(chat)
            createMsg(chat.msg, chat.isLocal)
          })
        })
      });
    }

    function createNew(name, id) {
      var pParent = document.getElementById("participants");
      var pNew = document.createElement("li");
      var pAvatar = document.createElement("img");
      var pName = document.createElement("span")

      pAvatar.src = "../../imgs/squestion.jpg";
      pAvatar.id = "participantAvatar";
      pName.className = "participantName";
      pName.innerHTML = ` ${name}`;
      pName.id = id

      pNew.onclick = function () {
        getMessages(id)
      }
      pNew.appendChild(pAvatar);
      pNew.appendChild(pName);
      pParent.appendChild(pNew);
    }
    ipcRenderer.invoke('request-imsgs').then(function (result) {
      if (result == "404") {
        createNew("Couldn't find Gmod")
      }
      result.forEach(rs => {
        console.log(rs)
        createNew(rs.name, rs.id)
      })
    });

    function createMsg(message, self) {
      var mParent = document.getElementById("messageContainer");
      var mNew = document.createElement("li");

      mNew.innerHTML = message
      if (self) {
        mNew.className = "self"
      } else {
        mNew.className = "opp"
      }
      mParent.appendChild(mNew);
    }
  </script>

</body>


</html>